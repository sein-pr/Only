{% extends "base.html" %}

{% block title %}Checkout - Only{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Checkout Form -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0">
                    <h4 class="mb-0 fw-bold">Checkout</h4>
                </div>
                <div class="card-body p-4">
                    <form id="checkoutForm">
                        
                        <!-- Shipping Information -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-shipping-fast me-2" style="color: #ea580c;"></i>
                                Shipping Information
                            </h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">First Name</label>
                                    <input type="text" class="form-control" id="firstName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">Last Name</label>
                                    <input type="text" class="form-control" id="lastName" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-medium">Address</label>
                                    <input type="text" class="form-control" id="address" placeholder="Street address" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-medium">City</label>
                                    <input type="text" class="form-control" id="city" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-medium">State</label>
                                    <select class="form-select" id="state" required>
                                        <option value="">Select State</option>
                                        <option value="OK">Okahnadja</option>
                                        <option value="RU">Rundu</option>
                                        <option value="WB">Walvis Bay</option>
                                        <option value="SM">Swakopmund</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-medium">ZIP Code</label>
                                    <input type="text" class="form-control" id="zipCode" required>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Information -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-credit-card me-2" style="color: #ea580c;"></i>
                                Payment Information
                            </h5>
                            
                            <!-- Stripe Elements -->
                            <div id="card-element" class="form-control p-3 mb-3">
                                <!-- Stripe Elements will create form elements here -->
                            </div>
                            
                            <!-- Error display -->
                            <div id="card-error" role="alert" class="alert alert-danger d-none"></div>
                        </div>
                        
                        <!-- Order Notes -->
                        <div class="mb-4">
                            <h5 class="fw-bold mb-3">
                                <i class="fas fa-sticky-note me-2" style="color: #ea580c;"></i>
                                Order Notes (Optional)
                            </h5>
                            <textarea class="form-control" id="orderNotes" rows="3" 
                                      placeholder="Any special instructions for your order..."></textarea>
                        </div>
                        
                        <!-- Terms and Conditions -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="terms" required>
                                <label class="form-check-label" for="terms">
                                    I agree to the <a href="#" style="color: #ea580c;">Terms and Conditions</a> 
                                    and <a href="#" style="color: #ea580c;">Privacy Policy</a>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Place Order Button -->
                        <button type="submit" class="btn btn-primary btn-lg w-100" id="placeOrderBtn">
                            <i class="fas fa-lock me-2"></i>Place Order Securely
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0 fw-bold">Order Summary</h5>
                </div>
                <div class="card-body">
                    <!-- Cart Items -->
                    <div class="mb-3">
                        {% for item in cart_items %}
                        <div class="d-flex align-items-center mb-3">
                            <img src="{{ item.product.image_url or '/placeholder.svg?height=60&width=60' }}" 
                                 alt="{{ item.product.name }}" class="me-3 rounded"
                                 style="width: 60px; height: 60px; object-fit: cover;">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-medium">{{ item.product.name }}</h6>
                                <small class="text-muted">Qty: {{ item.quantity }}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">${{ "%.2f"|format(item.product.price * item.quantity) }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <hr>
                    
                    <!-- Order Totals -->
                    <div class="mb-2 d-flex justify-content-between">
                        <span>Subtotal:</span>
                        <span>${{ "%.2f"|format(subtotal) }}</span>
                    </div>
                    <div class="mb-2 d-flex justify-content-between">
                        <span>Shipping:</span>
                        <span>{% if shipping == 0 %}Free{% else %} ${{ "%.2f"|format(shipping) }}{% endif %}</span>
                    </div>
                    <div class="mb-3 d-flex justify-content-between">
                        <span>Tax:</span>
                        <span>${{ "%.2f"|format(tax) }}</span>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between fw-bold h5">
                        <span>Total:</span>
                        <span style="color: #ea580c;">${{ "%.2f"|format(total) }}</span>
                    </div>
                    
                    <!-- Security Badges -->
                    <div class="mt-4 text-center">
                        <div class="row g-2">
                            <div class="col-4">
                                <i class="fas fa-shield-alt fa-2x text-success"></i>
                                <div class="small mt-1">Secure</div>
                            </div>
                            <div class="col-4">
                                <i class="fas fa-lock fa-2x text-success"></i>
                                <div class="small mt-1">Encrypted</div>
                            </div>
                            <div class="col-4">
                                <i class="fas fa-certificate fa-2x text-success"></i>
                                <div class="small mt-1">Verified</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_pk }}');
    const elements = stripe.elements();
    
    // Create card element
    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#424770',
                '::placeholder': {
                    color: '#aab7c4',
                },
            },
        },
    });
    
    cardElement.mount('#card-element');
    
    // Handle real-time validation errors from the card Element
    cardElement.on('change', ({error}) => {
        const displayError = document.getElementById('card-error');
        if (error) {
            displayError.textContent = error.message;
            displayError.classList.remove('d-none');
        } else {
            displayError.classList.add('d-none');
        }
    });
    
    // Handle form submission
    const form = document.getElementById('checkoutForm');
    const submitBtn = document.getElementById('placeOrderBtn');
    
    // Updated checkout form submission handler
// Updated form submission handler with better CSRF token handling
form.addEventListener('submit', async (event) => {
    event.preventDefault();
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Disable submit button and show loading
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing Payment...';
    submitBtn.disabled = true;
    
    try {
        // Try multiple ways to get CSRF token
        let csrfToken = null;
        
        // Method 1: Look for hidden input field
        const csrfInput = document.querySelector('input[name="csrf_token"]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        } else {
            // Method 2: Look for meta tag (add this to your HTML head)
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            if (csrfMeta) {
                csrfToken = csrfMeta.content;
            }
        }
        
        console.log('CSRF token found:', csrfToken ? 'yes' : 'no'); // Debug log
        
        // Create headers object
        const headers = {
            'Content-Type': 'application/json'
        };
        
        // Only add CSRF token if found
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }
        
        // Create payment intent
        const response = await fetch('/create-payment-intent', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                action: 'create_payment_intent' // Include some data
            })
        });
        
        console.log('Response status:', response.status); // Debug log
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server response:', errorText);
            
            let errorData;
            try {
                errorData = JSON.parse(errorText);
            } catch (e) {
                throw new Error(`Server error: ${response.status} - ${errorText}`);
            }
            throw new Error(errorData.error || 'Failed to create payment intent');
        }
        
        const { client_secret } = await response.json();
        
        // Collect shipping information
        const shippingInfo = {
            first_name: document.getElementById('firstName').value,
            last_name: document.getElementById('lastName').value,
            address: document.getElementById('address').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            zip_code: document.getElementById('zipCode').value
        };
        
        // Confirm payment
        const { error, paymentIntent } = await stripe.confirmCardPayment(client_secret, {
            payment_method: {
                card: cardElement,
                billing_details: {
                    name: `${shippingInfo.first_name} ${shippingInfo.last_name}`,
                    address: {
                        line1: shippingInfo.address,
                        city: shippingInfo.city,
                        state: shippingInfo.state,
                        postal_code: shippingInfo.zip_code,
                        country: 'US',
                    }
                },
            }
        });
        
        if (error) {
            console.error('Stripe error:', error);
            // Show error to customer
            const errorElement = document.getElementById('card-error');
            errorElement.textContent = error.message;
            errorElement.classList.remove('d-none');
            
            // Re-enable submit button
            submitBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Place Order Securely';
            submitBtn.disabled = false;
        } else {
            // Payment succeeded, process the order
            const processHeaders = {
                'Content-Type': 'application/json'
            };
            
            if (csrfToken) {
                processHeaders['X-CSRFToken'] = csrfToken;
            }
            
            const processResponse = await fetch('/process-stripe-payment', {
                method: 'POST',
                headers: processHeaders,
                body: JSON.stringify({
                    payment_intent_id: paymentIntent.id,
                    shipping_info: shippingInfo,
                    order_notes: document.getElementById('orderNotes').value
                })
            });
            
            const result = await processResponse.json();
            
            if (result.success) {
                // Redirect to order confirmation
                window.location.href = `/order-confirmation/${result.order_id}`;
            } else {
                throw new Error(result.error);
            }
        }
    } catch (error) {
        console.error('Payment error:', error);
        
        // Show error to customer
        const errorElement = document.getElementById('card-error');
        errorElement.textContent = error.message || 'An error occurred while processing your payment';
        errorElement.classList.remove('d-none');
        
        // Re-enable submit button
        submitBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Place Order Securely';
        submitBtn.disabled = false;
    }
});
</script>
{% endblock %}